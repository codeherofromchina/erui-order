<form id="save_purchase_form">
    <div id="save_purchase_panel_baseinfo" class="easyui-panel" title="基本信息"
         style="padding:10px;background:#fafafa;margin-bottom:10px;"
         data-options="collapsible:true">
        <div class="fitem">
            <label><span style="color:red;">*</span>采购合同号：</label>
            <input class="easyui-textbox" id="save_purchase_form_purch_no_field" required="true" style="width:180px;" buttonText="请选择" editable="false" name="purchNo"
                   data-options="onClickButton:function(){$('#save_purchase_purch_contract_dialog').dialog('open');$('#save_purchase_purch_contract_dialog').dialog('refresh', 'common/purchContractDialog.html');}"  />
            <label>合同签订日期：</label>
            <input class="easyui-textbox" id="save_purchase_form_signing_date_field" data-options="editable:false"/>
            <label>供应商名称：</label>
            <input class="easyui-textbox" id="save_purchase_form_supplier_name_field" data-options="editable:false"/>
        </div>
        <div class="fitem">
            <label><span style="color:red;">*</span>合同约定到货日期：</label>
            <input type="text" class="easyui-datebox" data-options="required:true,editable:false" style="width:180px;" name="arrivalDate"/>
            <label><span style="color:red;">*</span>合同标的物：</label>
            <input class="easyui-textbox" data-options="required:true" name="contractTag"/>
            <label>合同变更后到货日期：</label>
            <input type="text" class="easyui-datebox" data-options="editable:false" style="width:180px;" name="purChgDate"/>
        </div>
        <div class="fitem">
            <label>目标成本（人民币）：</label>
            <input class="easyui-numberbox" data-options="precision:2,min:0" name="goalCost" style="width:166px;"/>
            <span style="color:blue;"> 元</span>
            <label>节约资金（人民币）：</label>
            <input class="easyui-numberbox" data-options="precision:2,min:0" name="saveAmount" style="width:170px;"/>
            <span style="color:blue;"> 元</span>
            <label><span style="color:red;">*</span>节约方式：</label>
            <select class="easyui-combobox" editable="false" id="save_purchase_form_save_mode_field" name="saveMode"
                    data-options="required:true" validType="selectValueRequired['#save_purchase_form_save_mode_field']" panelHeight="125px">
                <option code="">无</option>
                <option code="1">对比投标</option>
                <option code="2">对比项目交付</option>
                <option code="3">对比预算</option>
                <option code="4">对比历史（含历史对比返点）</option>
            </select>
        </div>
        <div class="fitem">
            <label><span style="color:red;">*</span>定价方式：</label>
            <select class="easyui-combobox" editable="false" id="save_purchase_form_price_mode_field" name="priceMode"
                    data-options="required:true" validType="selectValueRequired['#save_purchase_form_price_mode_field']" style="width:180px;" panelHeight="175px">
                <option code="">无</option>
                <option code="1">招标</option>
                <option code="2">招标转竞争性谈判</option>
                <option code="3">小额采购谈判</option>
                <option code="4">询比价</option>
                <option code="5">执行集中谈判（框架协议）价格</option>
                <option code="6">参考历史价格</option>
            </select>
            <label>采购经办人：</label>
            <input class="easyui-textbox" data-options="editable:false" name="agentId" buttonText="请选择"/>
            <label>下发部门：</label>
            <input class="easyui-textbox" data-options="editable:false" name="department" buttonText="请选择"/>
        </div>
    </div>

    <div id="save_purchase_panel_goodsinfo" class="easyui-panel" title="商品信息"
         style="padding:10px;background:#fafafa;margin-bottom:10px;"
         data-options="collapsible:true">
        <div class="fitem">
            <label><span style="color:red;">*</span>采购总金额：</label>
            <input class="easyui-numberbox" data-options="precision:2,min:0,required:true" name="totalPrice" style="width:150px;"/>
            <span style="color:blue;"> CNY</span>
            <label><span style="color:red;">*</span>是否含税：</label>
            <input class="easyui-radio" type="radio" name="taxBearing" id="save_purchase_form_tax_bearing_1_field" code="1" checked> <label style="margin-left:0;width:50px;text-align: left;" for="save_purchase_form_tax_bearing_1_field">含税</label></input>
            <input class="easyui-radio" type="radio" name="taxBearing" id="save_purchase_form_tax_bearing_2_field" code="0"> <label style="margin-left:0;width:50px;text-align: left;" for="save_purchase_form_tax_bearing_2_field">不含税</label></input>
            <label style="width:160px;">采购总金额（USD）：</label>
            <input class="easyui-numberbox" data-options="precision:2,min:0" name="totalPriceUsd" code="0" editable="false" style="width:180px;"/>
        </div>

        <div class="fitem">
            <label><span style="color:red;">*</span>汇率：</label>
            <input class="easyui-numberbox" data-options="precision:4,min:0,required:true" id="save_purchase_form_exchange_rate_field" name="exchangeRate" style="width:180px;"/>
            <label><span style="color:red;">*</span>利润率%：</label>
            <input class="easyui-numberbox" data-options="precision:2,min:0,required:true" name="profitPercent" style="width:180px;"/>
        </div>

        <table id="save_purchase_form_goods_table"></table>
    </div>

    <div id="save_purchase_panel_settlement_info" class="easyui-panel" title="结算信息"
         style="padding:10px;background:#fafafa;margin-bottom:10px;"
         data-options="collapsible:true">
        <div id="save_purchase_panel_settlement_info_payment_div">
        </div>

        <div id="save_purchase_panel_settlement_info_add_btn_div">
            <a href="javascript:void(0);" id="save_purchase_panel_settlement_info_add_btn" class="easyui-linkbutton">添加付款记录</a> <span style="color:red;">至少一条</span>
        </div>
    </div>

    <div id="save_purchase_panel_other_info" class="easyui-panel" title="其他信息"
         style="padding:10px;background:#fafafa;margin-bottom:10px;"
         data-options="collapsible:true">
        <div class="fitem">
            <label style="width:120px;">备注：</label>
            <input class="easyui-textbox" multiline="true" style="width:560px;height:60px;" name="remarks" code=""  />
        </div>
    </div>

    <div id="save_purchase_panel_attachment_info" class="easyui-panel" title="附件（支持格式jpg、jpeg、png、gif、doc、docx、xls、xlsx、ppt、pptx、pdf、支持批量上传，单个附件不超过10M。）"
         style="background:#fafafa;margin-bottom:30px;"
         data-options="collapsible:true">
        <div class="easyui-layout" style="width: 100%;height:150px;">

            <div data-options="region:'west',split:false,border:false" style="width:150px;">
                <div style="text-align:center;">
                    <div style="margin-top:16px;margin-bottom:20px;"><span style="font-size: 14px;">采购执行部</span></div>
                    <div style="margin-bottom:8px;"><a href="javascript:void(0);" class="easyui-linkbutton" plain="true">上传合同及技术协议</a> </div>
                    <div style="margin-bottom:8px;"><a href="javascript:void(0);" class="easyui-linkbutton" plain="true">上传定价资料</a> </div>
                    <div><a href="javascript:void(0);" class="easyui-linkbutton" plain="true">上传其它</a> </div>
                </div>
            </div>
            <div data-options="region:'center',border:false" style="padding:5px;background:#eee;">
                <table class="easyui-datagrid" fit="true" fitColumn="true">
                    <thead>
                    <tr>
                        <th field="contractNo" width="200">附件名称</th>
                        <th field="projectNo" width="120">创建人</th>
                        <th field="contractNoHw" width="170">日期</th>
                        <th field="inquiryNo" width="80">操作</th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</form>
<div style="margin-top:20px;text-align: center;">
    <a href="javascript:void(0);" id="save_purchase_form_save_btn" size="large" class="easyui-linkbutton" style="margin-right:10px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;保存&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
    <a href="javascript:void(0);" id="save_purchase_form_submit_btn" size="large" class="easyui-linkbutton" style="margin-left:10px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;提交&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
</div>

<!-- 选择采购合同选择框 -->
<div id="save_purchase_purch_contract_dialog" style="width:600px;height:350px;">
</div>
<!-- /选择采购合同选择框 -->

<script type="text/javascript">
    var save_purchase_form_purch_payment_counter = 0;
    $(function(){
        $("#save_purchase_form_goods_table").datagrid({
            border:false,
            singleSelect:true,
            striped:true,
            rownumbers:true,
            columns:[[
                {field:'contractNo',width:110,title:'销售合同号'},
                {field:'projectNo',width:110,title:'项目号'},
                {field:'exeChgDate',width:100,title:'执行单变更后日期'},
                {field:'sku',width:125,title:'平台SKU'},
                {field:'nameEn',width:80,title:'外文品名'},
                {field:'nameZh',width:80,title:'中文品名'},
                {field:'unit',width:40,title:'单位'},
                {field:'brand',width:80,title:'品牌'},
                {field:'purchaseContractNum',width:80,title:'采购合同数量'},
                {field:'purchasedNum',width:90,title:'已采购数量'},
                {field:'purchaseNum',width:100,title:'本次采购数量',
                    editor:{
                        type:"numberbox",
                        options: {
                            min:1,
                            precision:0
                        }
                    }
                },
                {field:'purchasePrice',width:100,title:'单价',
                    editor:{
                        type:"numberbox",
                        options: {
                            required: true,
                            min:0.01,
                            precision:2
                        }
                    }
                },
                {field:'purchaseTotalPrice',width:100,title:'金额'},
                {field:'purchaseRemark',width:120,title:'备注',
                    editor:{
                        type:"textbox"
                    }
                }
            ]]
        });
        // 添加付款记录按钮触发事件
        $("#save_purchase_panel_settlement_info_add_btn").click(function (e) {
            e.preventDefault();
            var targetObj = $('<div class="fitem">\n' +
                '                <label><span style="color:red;">*</span>付款记录：</label>\n' +
                '                <select class="easyui-combobox" editable="false" name="purchPaymentList'+save_purchase_form_purch_payment_counter+'.type" id="save_purchase_form_payment_'+save_purchase_form_purch_payment_counter+'_type_field"\n' +
                '                        data-options="required:true" validType="selectValueRequired[\'#save_purchase_form_payment_'+save_purchase_form_purch_payment_counter+'_type_field\']">\n' +
                '                    <option code="">请选择付款方式</option>\n' +
                '                    <option code="1">预付</option>\n' +
                '                    <option code="2">进度</option>\n' +
                '                    <option code="3">提货前</option>\n' +
                '                    <option code="4">提货后</option>\n' +
                '                    <option code="5">质保金</option>\n' +
                '                </select>\n' +
                '                &nbsp;&nbsp;\n' +
                '                <input class="easyui-numberbox" data-options="min:0,precision:0,required:true" name="purchPaymentList'+save_purchase_form_purch_payment_counter+'.days" style="width: 100px;"/> <span class="standard_currency" style="width: 30px;"> 天</span>\n' +
                '                &nbsp;&nbsp;\n' +
                '                <input class="easyui-numberbox" data-options="min:0,precision:2,required:true" name="purchPaymentList'+save_purchase_form_purch_payment_counter+'.money" style="width: 100px;"/> <span class="standard_currency" style="width: 30px;"> CNY</span>\n' +
                '                <a href="javascript:void(0);" onclick="deletePurchPaymentList(this)" style="margin-left:50px;" class="easyui-linkbutton">删除</a>\n' +
                '            </div>').appendTo("#save_purchase_panel_settlement_info_payment_div");
            $.parser.parse(targetObj);
            ++save_purchase_form_purch_payment_counter;
        });

        $("#save_purchase_purch_contract_dialog").dialog({
            title:'选择采购合同号',
            resizable:true,
            modal:true,
            closed:true,
            cache: false,
            buttons:[{
                text:'确定',
                handler: function() {
                    var selectedTableRow = $("#common_purch_contract_dialog_table").datagrid("getSelected");
                    if (selectedTableRow) {
                        $("#save_purchase_form_purch_no_field").textbox("setValue",selectedTableRow.purchContractNo);
                        $("#save_purchase_form_purch_no_field").textbox("setText",selectedTableRow.purchContractNo);
                        // 获取采购合同详情并从中获取商品和合同签订日期和供应商信息
                        var purchContractData = loadPurchContractGoodsInfoInPurchase(selectedTableRow.id);
                        // 获取汇率
                        if (purchContractData) {
                            loadExchangeRateInPurchase(purchContractData.currencyBn, "USD");
                        }
                    }
                    $("#save_purchase_purch_contract_dialog").dialog("close");
                }
            },{
                text:'取消',
                handler:function(){
                    $("#save_purchase_purch_contract_dialog").dialog("close");
                }
            }]
        });
        // 提交采购按钮
        $("#save_purchase_form_submit_btn").click(function(e){
            e.preventDefault();

            closeCurrentTab();

        });
        // 保存采购按钮
        $("#save_purchase_form_save_btn").click(function(e){
            e.preventDefault();



        });
    });
    function deletePurchPaymentList(target) {
        $(target).parent().remove();
    }
    // 加载采购合同商品到采购添加面板
    function loadPurchContractGoodsInfoInPurchase(purchContractId){
        // 同步加载数据，异步填充面板
        var purchContractData = syncAjaxJson({"url":ORDER_URL + "/order/purchContract/detail"},{"id":purchContractId});
        if (purchContractData.code == 200) {
            var data = purchContractData.data;
            setTimeout(function(){
                // 合同签订日期
                $("#save_purchase_form_signing_date_field").textbox("setValue",data.signingDate);
                // 供应商名称
                $("#save_purchase_form_supplier_name_field").textbox("setValue",data.supplierName);
                // 组合商品信息
                var goodsData = [];
                $.each(data.purchContractGoodsList,function(index,purchContractGood) {
                    var obj = {};
                    obj.contractNo = purchContractGood.orderGoods.contractNo;
                    obj.projectNo = purchContractGood.orderGoods.projectNo;
                    obj.exeChgDate = purchContractGood.orderGoods.exeChgDate;
                    obj.sku = purchContractGood.orderGoods.sku;
                    obj.nameEn = purchContractGood.orderGoods.nameEn;
                    obj.nameZh = purchContractGood.orderGoods.nameZh;
                    obj.unit = purchContractGood.orderGoods.unit;
                    obj.brand = purchContractGood.orderGoods.brand;
                    obj.purchaseContractNum = purchContractGood.purchaseNum;
                    obj.purchasedNum = purchContractGood.purchasedNum;
                    obj.purchaseNum = "";
                    obj.purchasePrice = purchContractGood.purchasePrice;
                    goodsData.push(obj);
                });
                $("#save_purchase_form_goods_table").datagrid("loadData",goodsData);
                $.each(goodsData,function(index,d) {
                    $("#save_purchase_form_goods_table").datagrid("beginEdit",index);
                });
            },200);
            return data;
        }
        return null;
    }

    function loadExchangeRateInPurchase(fromBn, toBn) {
        $.ajax({
            type: 'post',
            url: 'http://api.eruidev.com/v3/common/Exchangerate/current',
            data: JSON.stringify({"cur_bn":fromBn,"to_cur_bn":toBn}),
            dataType: "json",
            beforeSend: beforeAjaxSend,
            contentType: 'application/json;charset=utf-8',
            success: function(data) {
                if (data.code == 1) {
                    $("#save_purchase_form_exchange_rate_field").numberbox("setValue",data.data.rate);
                }
            },
            error: function() {
                console.error("保存采购面板获取汇率出错");
            }
        });
    }

</script>